# 📐 МАТЕМАТИЧЕСКИЕ ФОРМУЛЫ - Scarlet Sails Trading Systems

**Дата:** 2025-11-11
**Цель:** Полное математическое описание всех трех моделей

---

## 📚 СОДЕРЖАНИЕ

1. [Модель 1: Rule-Based](#model1)
2. [Модель 2: ML XGBoost](#model2)
3. [Модель 3: Hybrid 3-Layer](#model3)
4. [Технические индикаторы](#indicators)
5. [Метрики оценки](#metrics)

---

<a name="model1"></a>
## 1️⃣ МОДЕЛЬ 1: RULE-BASED SYSTEM

### Формула входа

```
ENTRY(t) = 1  если RSI₁₄(t) < 30
           0  иначе

где:
  t = текущий бар
  RSI₁₄(t) = Relative Strength Index с периодом 14
  30 = порог перепроданности
```

### Математика RSI

```
RSI₁₄(t) = 100 - (100 / (1 + RS))

где:
  RS = avg_gain₁₄ / avg_loss₁₄

  avg_gain₁₄ = EMA₁₄(положительные изменения цены)
  avg_loss₁₄ = EMA₁₄(отрицательные изменения цены)

  EMA₁₄(x) = α·xₜ + (1-α)·EMA₁₄(xₜ₋₁)
  α = 2/(14+1) = 0.1333
```

### Пример расчета

```
Дано:
  Последние 14 баров с returns:
  [+0.5%, -0.3%, +1.2%, -0.8%, +0.4%, -0.2%, +0.9%, -1.1%,
   +0.3%, -0.5%, +1.5%, -0.6%, +0.7%, -0.4%]

Шаг 1: Разделить на gains и losses
  gains  = [0.5, 0, 1.2, 0, 0.4, 0, 0.9, 0, 0.3, 0, 1.5, 0, 0.7, 0]
  losses = [0, 0.3, 0, 0.8, 0, 0.2, 0, 1.1, 0, 0.5, 0, 0.6, 0, 0.4]

Шаг 2: Вычислить EMA₁₄
  avg_gain = EMA₁₄([0.5, 0, 1.2, ...]) ≈ 0.357
  avg_loss = EMA₁₄([0, 0.3, 0, 0.8, ...]) ≈ 0.271

Шаг 3: Вычислить RS
  RS = 0.357 / 0.271 ≈ 1.317

Шаг 4: Вычислить RSI
  RSI = 100 - (100 / (1 + 1.317))
      = 100 - (100 / 2.317)
      = 100 - 43.17
      = 56.83

Результат: RSI = 56.83 → НЕ перепродано (> 30) → НЕ входим
```

### Выход из позиции

```
EXIT(t) = t_entry + 96 баров

где:
  t_entry = бар входа
  96 = 24 часа на таймфрейме 15m
```

### Прибыльность трейда

```
PnL(%) = (P_exit - P_entry) / P_entry × 100

Profit = 1  если PnL > 1.0%
         0  если PnL ≤ 1.0%
```

---

<a name="model2"></a>
## 2️⃣ МОДЕЛЬ 2: ML XGBOOST

### Формула входа

```
ENTRY(t) = 1  если P(UP|X) ≥ 0.65
           0  иначе

где:
  P(UP|X) = вероятность роста цены > 1% за 24 часа
  X = [x₁, x₂, ..., x₃₁] = вектор из 31 признака
  0.65 = порог уверенности (65%)
```

### Вектор признаков X (31 feature)

```
X = [X_primary, X_1h, X_4h, X_1d]

X_primary (13 признаков с primary таймфрейма 15m):
  x₁  = RSI₁₄(t)
  x₂  = EMA₉(t)
  x₃  = EMA₂₁(t)
  x₄  = SMA₅₀(t)
  x₅  = BB_upper(t)
  x₆  = BB_middle(t)
  x₇  = BB_lower(t)
  x₈  = BB_width(t)
  x₉  = ATR₁₄(t)
  x₁₀ = returns₅(t)
  x₁₁ = returns₁₀(t)
  x₁₂ = volume_ratio₅(t)
  x₁₃ = volume_ratio₁₀(t)

X_1h (6 признаков с 1-часового таймфрейма):
  x₁₄ = close_1h(t)
  x₁₅ = EMA₉_1h(t)
  x₁₆ = EMA₂₁_1h(t)
  x₁₇ = SMA₅₀_1h(t)
  x₁₈ = RSI₁₄_1h(t)
  x₁₉ = returns₅_1h(t)

X_4h (6 признаков с 4-часового таймфрейма):
  x₂₀ = close_4h(t)
  x₂₁ = EMA₉_4h(t)
  x₂₂ = EMA₂₁_4h(t)
  x₂₃ = SMA₅₀_4h(t)
  x₂₄ = RSI₁₄_4h(t)
  x₂₅ = returns₅_4h(t)

X_1d (6 признаков с дневного таймфрейма):
  x₂₆ = close_1d(t)
  x₂₇ = EMA₉_1d(t)
  x₂₈ = EMA₂₁_1d(t)
  x₂₉ = SMA₅₀_1d(t)
  x₃₀ = RSI₁₄_1d(t)
  x₃₁ = returns₅_1d(t)
```

### Нормализация признаков (StandardScaler)

```
X_scaled = (X - μ) / σ

где:
  μ = [μ₁, μ₂, ..., μ₃₁] = вектор средних значений (из train set)
  σ = [σ₁, σ₂, ..., σ₃₁] = вектор стандартных отклонений (из train set)

Для каждого признака:
  x_scaled_i = (x_i - μ_i) / σ_i

Пример:
  x₁ = RSI = 28.4
  μ₁ = 50.0  (среднее RSI на train set)
  σ₁ = 15.0  (std RSI на train set)

  x₁_scaled = (28.4 - 50.0) / 15.0 = -1.44
```

### XGBoost предсказание

```
P(UP|X) = sigmoid(∑ᵢ₌₁ᵀ fᵢ(X_scaled))

где:
  T = 200 деревьев
  fᵢ(X) = предсказание i-го дерева
  sigmoid(z) = 1 / (1 + e⁻ᶻ)

Каждое дерево fᵢ(X):
  fᵢ(X) = leafᵢ,ⱼ  где j определяется путем по дереву

Пример дерева:
  if x₁ < -1.0:  (RSI низкий?)
    if x₁₉ > 0.5:  (1h returns положительные?)
      if x₃₁ > 1.0:  (1d returns сильно положительные?)
        return +0.05  (голос "UP")
      else:
        return -0.02  (голос "DOWN")
    else:
      return -0.03
  else:
    return -0.01
```

### Итоговая формула

```
Вход в позицию, если:

  sigmoid(∑ᵢ₌₁²⁰⁰ fᵢ((X - μ) / σ)) ≥ 0.65

Полный pipeline:
  1. Извлечь X = [x₁, ..., x₃₁] из 4 таймфреймов
  2. Нормализовать: X_scaled = (X - μ) / σ
  3. Предсказать: z = ∑ᵢ₌₁²⁰⁰ fᵢ(X_scaled)
  4. Вероятность: P(UP) = 1 / (1 + e⁻ᶻ)
  5. Решение: ENTRY = 1 если P(UP) ≥ 0.65, иначе 0
```

### Целевая переменная (label) для обучения

```
y(t) = 1  если future_return(t) > 1.0%
       0  иначе

где:
  future_return(t) = (close(t+96) - close(t)) / close(t) × 100

Обучение:
  Дано: {(X₁, y₁), (X₂, y₂), ..., (Xₙ, yₙ)}
  Цель: найти 200 деревьев {f₁, f₂, ..., f₂₀₀}, которые минимизируют:

  Loss = ∑ᵢ₌₁ⁿ log_loss(yᵢ, P(UP|Xᵢ))

  log_loss(y, p) = -y·log(p) - (1-y)·log(1-p)
```

### Class balancing

```
При обучении применяется взвешивание классов:

  weight(y=0) = 1.0
  weight(y=1) = N₀ / N₁ = scale_pos_weight

где:
  N₀ = количество DOWN примеров (67%)
  N₁ = количество UP примеров (33%)

В нашем случае:
  scale_pos_weight = 32,963 / 16,164 ≈ 2.04

Это говорит модели: "Ошибка на UP в 2.04 раза важнее, чем на DOWN"
```

---

<a name="model3"></a>
## 3️⃣ МОДЕЛЬ 3: HYBRID 3-LAYER

### Формула входа (3 слоя)

```
ENTRY(t) = L₁(t) ∧ L₂(t) ∧ L₃(t)

где:
  L₁(t) = Layer 1 (Rule-based filter)
  L₂(t) = Layer 2 (ML filter)
  L₃(t) = Layer 3 (Crisis gate)
  ∧ = логическое И (все три должны быть TRUE)
```

### Layer 1: Rule-based filter

```
L₁(t) = 1  если RSI₁₄(t) < 30
        0  иначе

(идентично Rule-Based модели)
```

### Layer 2: ML filter

```
L₂(t) = 1  если P(UP|X) ≥ 0.65
        0  иначе

где P(UP|X) вычисляется через XGBoost (см. Модель 2)
```

### Layer 3: Crisis gate

```
L₃(t) = ¬crisis(t)

crisis(t) = 1  если любое из:
                 - VIX(t) > 30
                 - BTC_drawdown(t) > 20%
                 - volume_spike(t) > 5×
            0  иначе

где:
  VIX(t) = индекс волатильности (Crypto Fear & Greed Index)
  BTC_drawdown(t) = max падение от ATH за последние 30 дней
  volume_spike(t) = volume(t) / avg_volume₃₀(t)
```

### Полная формула

```
ENTRY(t) = [RSI₁₄(t) < 30] ∧
           [sigmoid(∑ᵢ₌₁²⁰⁰ fᵢ((X-μ)/σ)) ≥ 0.65] ∧
           [¬crisis(t)]

Словами:
  "Входим, если RSI показывает перепроданность (< 30)
   И ML дает высокую уверенность роста (≥ 65%)
   И на рынке нет кризиса"
```

### Вероятностная интерпретация

```
P(Profit | ENTRY) = P(Profit | L₁ ∧ L₂ ∧ L₃)

Если слои независимы (упрощение):
  P(Profit | ENTRY) ≈ P(Profit | L₁) × P(Profit | L₂) × P(Profit | L₃)

Эмпирически:
  P(Profit | L₁) ≈ 0.51  (Rule-based WR)
  P(Profit | L₂) ≈ 0.59  (ML WR)
  P(Profit | L₃) ≈ 0.95  (Crisis gate редко срабатывает)

  P(Profit | ENTRY) ≈ 0.51 × 0.59 × 0.95 ≈ 0.286 (28.6%?)

НО: слои НЕ независимы! L₂ фильтрует именно те сигналы L₁,
которые ложные. Поэтому реальная WR выше:

  P(Profit | ENTRY) ≈ 0.65-0.72  (65-72% эмпирически)
```

---

<a name="indicators"></a>
## 4️⃣ ТЕХНИЧЕСКИЕ ИНДИКАТОРЫ

### RSI (Relative Strength Index)

```
RSI_n(t) = 100 - 100/(1 + RS_n(t))

RS_n(t) = EMA_n(gains) / EMA_n(losses)

где:
  gains_t = max(close_t - close_{t-1}, 0)
  losses_t = max(close_{t-1} - close_t, 0)
```

### EMA (Exponential Moving Average)

```
EMA_n(t) = α·close_t + (1-α)·EMA_n(t-1)

где:
  α = 2/(n+1)  (сглаживающий коэффициент)

Примеры:
  EMA_9:  α = 2/10 = 0.20
  EMA_21: α = 2/22 = 0.091
```

### SMA (Simple Moving Average)

```
SMA_n(t) = (1/n) × ∑ᵢ₌₀ⁿ⁻¹ close_{t-i}

Пример SMA_50:
  SMA_50(t) = (close_t + close_{t-1} + ... + close_{t-49}) / 50
```

### Bollinger Bands

```
BB_middle(t) = SMA_20(t)

BB_upper(t) = BB_middle(t) + 2·σ₂₀(t)

BB_lower(t) = BB_middle(t) - 2·σ₂₀(t)

BB_width(t) = (BB_upper(t) - BB_lower(t)) / BB_middle(t)

где:
  σ₂₀(t) = стандартное отклонение цены за последние 20 баров
  σ₂₀(t) = √[(1/20)·∑ᵢ₌₀¹⁹(close_{t-i} - SMA_20(t))²]
```

### ATR (Average True Range)

```
ATR_n(t) = EMA_n(TR(t))

TR(t) = max(high_t - low_t,
            |high_t - close_{t-1}|,
            |low_t - close_{t-1}|)

Пример ATR_14:
  TR_t = max(59100 - 58800, |59100 - 58650|, |58800 - 58650|)
       = max(300, 450, 150)
       = 450

  ATR_14(t) = EMA_14([TR_t, TR_{t-1}, ..., TR_{t-13}])
```

### Returns

```
returns_n(t) = (close_t - close_{t-n}) / close_{t-n}

Примеры:
  returns_5(t)  = (close_t - close_{t-5}) / close_{t-5}
  returns_10(t) = (close_t - close_{t-10}) / close_{t-10}

В процентах:
  returns_n(t) × 100
```

### Volume Ratio

```
volume_ratio_n(t) = volume_t / SMA_n(volume_t)

Пример:
  volume_t = 1,500,000
  SMA_5(volume) = 1,200,000

  volume_ratio_5(t) = 1,500,000 / 1,200,000 = 1.25

Интерпретация:
  > 1.0 = выше среднего объема
  < 1.0 = ниже среднего объема
```

---

<a name="metrics"></a>
## 5️⃣ МЕТРИКИ ОЦЕНКИ

### Win Rate

```
WR = N_wins / N_total × 100%

где:
  N_wins = количество прибыльных трейдов
  N_total = общее количество трейдов
```

### Profit Factor

```
PF = Total_Profit / Total_Loss

где:
  Total_Profit = ∑ᵢ∈wins PnL_i
  Total_Loss = |∑ᵢ∈losses PnL_i|

Интерпретация:
  PF > 1.0 = прибыльная система
  PF = 1.0 = нулевая система
  PF < 1.0 = убыточная система

Примеры:
  PF = 2.0 = на каждый $1 убытка приходится $2 прибыли
  PF = 3.20 = на каждый $1 убытка приходится $3.20 прибыли
```

### Sharpe Ratio (если применимо)

```
SR = (R̄ - Rf) / σ_R

где:
  R̄ = средняя доходность трейда
  Rf = безрисковая ставка (обычно 0 для крипто)
  σ_R = стандартное отклонение доходности

SR > 1.0 = хорошая стратегия
SR > 2.0 = отличная стратегия
```

### Maximum Drawdown

```
MDD = max_t [(Peak_t - Trough_t) / Peak_t] × 100%

где:
  Peak_t = максимальная кумулятивная прибыль до момента t
  Trough_t = минимальная кумулятивная прибыль после Peak_t

Пример:
  Кумулятивная прибыль: [0, +5%, +8%, +3%, -2%, +1%, +6%]
  Peak = +8% (на баре 2)
  Trough = -2% (на баре 4)
  MDD = (8% - (-2%)) / 8% × 100% = 125% ? НЕТ!

Правильно:
  Equity: [100, 105, 108, 103, 98, 101, 106]
  Peak = 108
  Trough = 98
  MDD = (108 - 98) / 108 × 100% = 9.26%
```

### Total PnL

```
Total_PnL = ∑ᵢ₌₁ᴺ PnL_i

где:
  PnL_i = (exit_price_i - entry_price_i) / entry_price_i × 100%
```

---

## 📝 ПРИМЕР ПОЛНОГО РАСЧЕТА

Рассмотрим конкретный бар:

```
Дата: 2024-10-15 14:30:00
Актив: BTC

═══════════════════════════════════════════════════════════
ИСХОДНЫЕ ДАННЫЕ
═══════════════════════════════════════════════════════════
15m (primary):
  close = $58,234
  RSI_14 = 28.4
  EMA_9 = $58,200
  EMA_21 = $58,100
  SMA_50 = $58,000
  BB_upper = $59,500
  BB_middle = $58,250
  BB_lower = $57,000
  BB_width = 0.043
  ATR_14 = $450
  returns_5 = -0.008
  returns_10 = -0.015
  volume_ratio_5 = 1.35
  volume_ratio_10 = 1.28

1h:
  close = $58,150
  EMA_9 = $58,400
  EMA_21 = $58,500
  SMA_50 = $58,600
  RSI_14 = 42.3
  returns_5 = 0.012

4h:
  close = $58,000
  EMA_9 = $58,800
  EMA_21 = $59,000
  SMA_50 = $59,200
  RSI_14 = 48.5
  returns_5 = 0.025

1d:
  close = $57,500
  EMA_9 = $59,000
  EMA_21 = $59,500
  SMA_50 = $60,000
  RSI_14 = 52.1
  returns_5 = 0.035

═══════════════════════════════════════════════════════════
МОДЕЛЬ 1: RULE-BASED
═══════════════════════════════════════════════════════════

Проверка:
  RSI_14 = 28.4 < 30 ? ДА

Решение: ENTRY ✅

═══════════════════════════════════════════════════════════
МОДЕЛЬ 2: ML XGBOOST
═══════════════════════════════════════════════════════════

Шаг 1: Извлечь X
  X = [28.4, 58200, 58100, 58000, 59500, 58250, 57000, 0.043,
       450, -0.008, -0.015, 1.35, 1.28,
       58150, 58400, 58500, 58600, 42.3, 0.012,
       58000, 58800, 59000, 59200, 48.5, 0.025,
       57500, 59000, 59500, 60000, 52.1, 0.035]

Шаг 2: Нормализация
  μ = [50.0, 55000, 55000, 55000, 57000, 55500, 54000, 0.035,
       600, 0.000, 0.000, 1.0, 1.0,
       55000, 55000, 55000, 55000, 50.0, 0.000,
       55000, 55000, 55000, 55000, 50.0, 0.000,
       55000, 55000, 55000, 55000, 50.0, 0.000]

  σ = [15.0, 5000, 5000, 5000, 5000, 5000, 5000, 0.015,
       200, 0.02, 0.03, 0.5, 0.5,
       5000, 5000, 5000, 5000, 15.0, 0.02,
       5000, 5000, 5000, 5000, 15.0, 0.02,
       5000, 5000, 5000, 5000, 15.0, 0.02]

  X_scaled = (X - μ) / σ
           = [(-1.44), (0.65), (0.62), (0.60), (0.50), (0.55), (0.60), (0.53),
              (-0.75), (-0.40), (-0.50), (0.70), (0.56),
              (0.63), (0.68), (0.70), (0.72), (-0.51), (0.60),
              (0.60), (0.76), (0.80), (0.84), (-0.10), (1.25),
              (0.50), (0.80), (0.90), (1.00), (0.14), (1.75)]

Шаг 3: XGBoost prediction
  Tree 1: if x_scaled[0] < -1.0 → if x_scaled[30] > 1.0 → +0.05
  Tree 2: if x_scaled[24] > 0.5 → if x_scaled[25] > 1.0 → +0.04
  ...
  Tree 200: if x_scaled[30] > 1.5 → +0.06

  z = ∑ tree_outputs ≈ 0.75

Шаг 4: Sigmoid
  P(UP) = 1 / (1 + e^(-0.75))
        = 1 / (1 + 0.472)
        = 1 / 1.472
        = 0.68

Шаг 5: Решение
  P(UP) = 0.68 ≥ 0.65 ? ДА

Решение: ENTRY ✅

═══════════════════════════════════════════════════════════
МОДЕЛЬ 3: HYBRID
═══════════════════════════════════════════════════════════

Layer 1:
  RSI_14 = 28.4 < 30 ? ДА ✅

Layer 2:
  P(UP) = 0.68 ≥ 0.65 ? ДА ✅

Layer 3:
  Crisis detected? НЕТ ✅

Решение: ENTRY ✅ (все 3 слоя прошли)

═══════════════════════════════════════════════════════════
РЕЗУЛЬТАТ ТРЕЙДА
═══════════════════════════════════════════════════════════

Entry: $58,234 (2024-10-15 14:30)
Exit:  $59,102 (2024-10-16 14:30, через 96 баров = 24h)

PnL = (59102 - 58234) / 58234 × 100%
    = 868 / 58234 × 100%
    = 1.49%

Profit? 1.49% > 1.0% → ДА ✅

═══════════════════════════════════════════════════════════
ВЫВОД
═══════════════════════════════════════════════════════════

Все три модели:
  ✅ Rule-Based вошла (RSI < 30)
  ✅ ML вошла (P(UP) = 0.68)
  ✅ Hybrid вошла (все слои прошли)

Результат:
  ✅ ПРИБЫЛЬ +1.49%

Это пример сигнала, где все три модели СОГЛАСНЫ.
```

---

**Дата:** 2025-11-11
**Версия:** 1.0
