# –î–ï–ù–¨ 2: REAL INTEGRATION WORK + ADAPTIVE TP/SL

## üéØ –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –î–Ω—è 2
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ + –Ω–∞–π—Ç–∏ –ê–î–ê–ü–¢–ò–í–ù–´–ï TP/SL:
1. **Adaptive TP/SL** ‚Üí Grid Search –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π (TRAIN + OOT)
2. **SimpleOpportunityScorer** ‚Üí —É–ª—É—á—à–∏—Ç—å —Å–µ–ª–µ–∫—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤
3. **CostCalculator** ‚Üí —á–µ—Å—Ç–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –≤–æ –≤—Å–µ—Ö –±—ç–∫—Ç–µ—Å—Ç–∞—Ö

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–î–µ–Ω—å 1)
```
‚úÖ ML —Ñ–∏–∫—Å –∑–∞–≤–µ—Ä—à–µ–Ω (OOD 8.1%)
‚úÖ Comprehensive audit: ML WR 57.8%, Hybrid WR 57.2%
‚úÖ Realistic backtest: Rule-Based WR 36.8%, PF 0.52
‚è≥ –ü–†–û–ë–õ–ï–ú–ê: ML shows WR 35.0% –≤ realistic (–ø–∞–¥–µ–Ω–∏–µ 22.8%!)
```

## üîß –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ù–û –ù–ï –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–´!)
```
‚úÖ /features/crisis_detection.py      # Crisis classifier
‚úÖ /scripts/analyze_market_regime.py  # Regime detector
‚úÖ /models/*                           # –û–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
```

## üìã –î–ï–ù–¨ 2 - –ó–ê–î–ê–ß–ò

### –ó–∞–¥–∞—á–∞ 2.0: Adaptive TP/SL Grid Search (–ù–û–í–ê–Ø! –ö–†–ò–¢–ò–ß–ù–ê–Ø!)
**–í–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö TP/SL, –∏—â–µ–º –ê–î–ê–ü–¢–ò–í–ù–´–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

–ü—Ä–æ–±–ª–µ–º–∞: –û–¥–Ω–∏ TP/SL –¥–ª—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫ = –ø–ª–æ—Ö–æ
–†–µ—à–µ–Ω–∏–µ: –†–∞–∑–Ω—ã–µ TP/SL –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö = —Ö–æ—Ä–æ—à–æ

**–°–∫—Ä–∏–ø—Ç:** `grid_search_adaptive_tp_sl.py`
- Grid Search –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π TP (0.5%-2.75%) √ó SL (-2.0% to -0.25%)
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–∞ TRAIN (2020-2023) –∏ OOT (2024)
- –ù–∞—Ö–æ–¥–∏—Ç STABLE –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–±–æ–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö)
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç: –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö?

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ STABLE:**
- TRAIN WR >= 45%
- OOT WR >= 40%
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: |TRAIN WR - OOT WR| <= 10%
- –ú–∏–Ω–∏–º—É–º 100 —Å–¥–µ–ª–æ–∫

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- CSV —Å TOP-10 –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏
- JSON —Å best TP/SL –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- Insights: –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–¥–∞–ø—Ç–∏–≤–Ω–µ–µ?

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–ö–†–ò–ü–¢ –°–û–ó–î–ê–ù, –ì–û–¢–û–í –ö –ó–ê–ü–£–°–ö–£

---

### –ó–∞–¥–∞—á–∞ 2.1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–°–û–ó–î–ê–ù–ê!)
- –°–∫—Ä–∏–ø—Ç: `backtest_ml_diagnostic.py`
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç Comprehensive vs Realistic –Ω–∞ –û–î–ù–ò–• –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–π–º—ë—Ç –ø–æ—á–µ–º—É —Ä–∞–∑–Ω–∏—Ü–∞ –≤ 22.8%
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í –ö –ó–ê–ü–£–°–ö–£

### –ó–∞–¥–∞—á–∞ 2.2: SimpleOpportunityScorer
**–ß—Ç–æ —ç—Ç–æ?**
```python
class SimpleOpportunityScorer:
    def score(self, market_state, ml_prob, regime, is_crisis):
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å–∏–≥–Ω–∞–ª –ø–æ:
        - ML probability (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∫—Ç–æ—Ä)
        - Regime (bull > sideways > bear)
        - Crisis (if crisis ‚Üí score = 0)
        - Volatility (high vol ‚Üí lower score)
        """
        if is_crisis:
            return 0  # –ù–µ —Ç–æ—Ä–≥—É–µ–º –≤ –∫—Ä–∏–∑–∏—Å

        score = ml_prob

        # –ë–æ–Ω—É—Å –∑–∞ —Ä–µ–∂–∏–º
        if regime == 'bull':
            score *= 1.2
        elif regime == 'bear':
            score *= 0.8

        # –®—Ç—Ä–∞—Ñ –∑–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
        if volatility > threshold:
            score *= 0.7

        return score
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã ‚Üí ‚Üì trades, ‚Üë WR

### –ó–∞–¥–∞—á–∞ 2.3: CostCalculator —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è
**–ß—Ç–æ —ç—Ç–æ?**
```python
class CostCalculator:
    def __init__(self, base_fee=0.15, slippage=0.15):
        self.round_trip = base_fee * 2 + slippage  # 0.45%

    def apply_to_backtest(self, entry_price, exit_price, position_size):
        """
        –†–µ–∞–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ –∏–∑–¥–µ—Ä–∂–∫–∏:
        - Maker/Taker fees
        - Slippage
        - Position size (–±–æ–ª—å—à–∏–µ —Å–¥–µ–ª–∫–∏ ‚Üí –±–æ–ª—å—à–µ slippage)
        """
```

**–°–µ–π—á–∞—Å:** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 0.3%
**–ù—É–∂–Ω–æ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞

### –ó–∞–¥–∞—á–∞ 2.4: RiskPenaltyCalculator
**–ß—Ç–æ —ç—Ç–æ?**
```python
class RiskPenaltyCalculator:
    def penalty_for_signal(self, signal, portfolio_state, risk_metrics):
        """
        –®—Ç—Ä–∞—Ñ—É–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –∫–æ—Ç–æ—Ä—ã–µ:
        - –£–≤–µ–ª–∏—á–∏–≤–∞—é—Ç MDD —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
        - –ö–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç —Å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
        - –ü—Ä–µ–≤—ã—à–∞—é—Ç daily loss limits
        - –°–æ–∑–¥–∞—é—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π leverage
        """
        if current_mdd > max_mdd:
            return 0  # –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª

        penalty = correlation_penalty + leverage_penalty
        return signal_prob * (1 - penalty)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è

## üîÑ WORKFLOW –î–Ω—è 2
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å backtest_ml_diagnostic.py
   ‚Üì
2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ—á–µ–º—É WR 35%?)
   ‚Üì
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å SimpleOpportunityScorer
   ‚Üì
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å backtest —Å OpportunityScorer
   ‚Üì
5. –°—Ä–∞–≤–Ω–∏—Ç—å —Å baseline
   ‚Üì
6. –ï—Å–ª–∏ —É–ª—É—á—à–∏–ª–æ—Å—å ‚Üí –¥–æ–±–∞–≤–∏—Ç—å CostCalculator
   ‚Üì
7. –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ—Å—Ç —Å –æ–±–æ–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
```

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –í–û–ü–†–û–°–´
1. **–ü–æ—á–µ–º—É ML WR —É–ø–∞–ª —Å 57.8% –¥–æ 35.0%?**
   - SL —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ?
   - ML –º–æ–¥–µ–ª—å –Ω–µ –∫–∞–ª–∏–±—Ä–∏—Ä–æ–≤–∞–Ω–∞?
   - Data leakage –≤ comprehensive?

2. **–ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã?**
   - TP 1.0% vs 2.0%?
   - SL -0.5% vs -1.0%?
   - –ë–µ–∑ SL –≤–æ–æ–±—â–µ?

3. **–ì–¥–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Crisis Filter?**
   - –ù–∞ —É—Ä–æ–≤–Ω–µ ML probability?
   - –ù–∞ —É—Ä–æ–≤–Ω–µ entry decision?
   - –ù–∞ —É—Ä–æ–≤–Ω–µ portfolio?

## üìÖ NEXT STEPS
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
- –£–≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
- –ò—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ù–µ "–¥–µ–ª–∞—Ç—å –≤–∏–¥" —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ –†–ï–ê–õ–¨–ù–û —Ä–∞–±–æ—Ç–∞—Ç—å

---

**–§–∏–ª–æ—Å–æ—Ñ–∏—è –î–µ–Ω—å 2:**
- ‚úÖ –ß–µ—Å—Ç–Ω—ã–µ —á–∏—Å–ª–∞
- ‚úÖ –†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–ª—é–∑–∏—é
